---
title: "RANDOM SURVIVAL FORESTS (RSF) AND SHAP ANALYSIS"
subtitle: "TABLE ONE"
author:
  - "Theophilus G. Baidoo^[tbaidoo@iu.edu, Indiana University Bloomington.]"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: true
    latex_engine: xelatex
    number_sections: false
    toc: False
    toc_depth: 4
header-includes:
  - \usepackage{amsmath}
  - \usepackage{pdfpages}
  - \usepackage{amssymb}
  - \usepackage{amsfonts}
  - \usepackage{amsthm}
  - \usepackage{floatrow}
  - \usepackage{pdfpages}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \rhead{Theophilus Baidoo}
  - \lhead{}
  - \cfoot{\thepage}
  - \usepackage{algorithm}
  - \usepackage[noend]{algpseudocode}
geometry: margin=0.8in
fontsize: 12pt
params:
  proj_number:
  proj_title: ""
---

```{r, warning=FALSE}
library(SurvMetrics)
library(caret)
library(randomForestSRC)
library(survival)  
library(pec)
library(ggplot2)
library(dplyr)
library(gtsummary)
library(gt)
set.seed(123)
```


```{r}
mydata <- read.csv("SEER.csv")

head(mydata)


new_names <- c("Progesterone.Status" = "P.Status",
               "Estrogen.Status" = "E.Status",
               "Regional.Node.Examined" = "Reg.Examined",
               "Reginol.Node.Positive" = "Reg.Positive",
               "Marital.Status" = "M.Status")

for (old_name in names(new_names)) {
  mydata <- mydata %>% rename(!!new_names[old_name] := !!sym(old_name))
}


mydata <- mydata %>%
  mutate(Race = case_when(
    Race == "Other (American Indian/AK Native, Asian/Pacific Islander)" ~ "Other",
    Race == "White" ~ "White",
    Race == "Black" ~ "Black"
  )) %>%
  mutate(Grade = case_when(
    Grade == "Moderately differentiated; Grade II" ~ "Grade II",
    Grade == "Poorly differentiated; Grade III" ~ "Grade III",
    Grade == "Well differentiated; Grade I" ~ "Grade I",
    Grade == "Undifferentiated; anaplastic; Grade IV" ~ "Grade IV"
  )) %>%
  mutate(M.Status = case_when(
    M.Status == "Married (including common law)" ~ "Married",
    M.Status == "Divorced" ~ "Divorced",
    M.Status == "Single (never married)" ~ "Single",
    M.Status == "Widowed" ~ "Widowed",
    M.Status == "Separated" ~ "Separated"
  )) %>%
  mutate(Status = ifelse(Status == "Alive", 0, 1))


categorical_vars <- c("Race", "M.Status", "T.Stage", "N.Stage", "A.Stage", "Grade", "E.Status", "P.Status","Status")
mydata[categorical_vars] <- lapply(mydata[categorical_vars], as.factor)
mydata <- mydata[, -6] # Remove unnecessary column (adjust as necessary)


for(i in seq_along(mydata)) {
  if(is.character(mydata[[i]])) {
    mydata[[i]] <- as.factor(mydata[[i]])
  }
}


head(mydata)
str(mydata)


# Identify continuous variables by checking if they are numeric
continuous_vars <- sapply(mydata, is.numeric)

# Function to check normality and plot
for (var in names(mydata)[continuous_vars]) {
  cat("Normality check for:", var, "\n")
  
  # Shapiro-Wilk test for normality
  shapiro_test <- shapiro.test(mydata[[var]])
  print(shapiro_test)
  
 
  if (shapiro_test$p.value < 0.05) {
    cat("Non-normally distributed (use median, Q1, Q3)\n\n")
  } else {
    cat("Normally distributed (use mean and SD)\n\n")
  }
  
  
  par(mfrow=c(1, 2))
  hist(mydata[[var]], main = paste("Histogram of", var), xlab = var)
  qqnorm(mydata[[var]], main = paste("Q-Q plot of", var))
  qqline(mydata[[var]])
}
par(mfrow=c(1, 1)) 



```




```{r}


data_selected <- mydata %>%
 
  dplyr::select(-Survival.Months) %>%
  
  # Create custom categories for Age and Tumor Size
  mutate(
    Age_Category = case_when(
      Age >= 30 & Age <= 50 ~ "30-50",
      Age >= 51 & Age <= 60 ~ "51-60",
      Age >= 61 & Age <= 70 ~ "61-70",
      TRUE ~ "Other"
    ),
    Tumor_Size_Category = case_when(
      Tumor.Size < 25 ~ "<25mm",
      Tumor.Size >= 25 & Tumor.Size <= 45 ~ "25-45mm",
      Tumor.Size > 45 ~ ">45mm"
    ),
    
    
    Race = as.factor(Race),
    M.Status = as.factor(M.Status),
    T.Stage = as.factor(T.Stage),
    N.Stage = as.factor(N.Stage),
    Grade = as.factor(Grade),
    E.Status = as.factor(E.Status),
    P.Status = as.factor(P.Status),
    Status = as.factor(Status),
    Age_Category = as.factor(Age_Category),
    Tumor_Size_Category = as.factor(Tumor_Size_Category)
  ) %>%
  # Reorder columns to have Age and Tumor Size categories at the top
  dplyr::select(
    Age_Category, Tumor_Size_Category,  # Place these at the top
    Race, M.Status, T.Stage, Grade, Status, 
    E.Status, P.Status, N.Stage
  )


custom_stats <- list(
  all_continuous() ~ "{median} ({p25}, {p75})",
  all_categorical() ~ "{n} ({p}%)"
)

# Generate the summary table stratified by N.Stage, with simulated p-values for Fisher's Exact Test
table_one <- tbl_summary(
  data = data_selected,
  by = N.Stage,
  statistic = custom_stats,
  digits = all_continuous() ~ 2  # Set decimal places for continuous variables
) %>%
  add_p(
    test = everything() ~ "fisher.test",
    test.args = everything() ~ list(simulate.p.value = TRUE)  # Use simulation for Fisher's test
  ) %>%
  add_overall() %>%                # Add an overall summary column
  modify_header(label = "**Variable**") %>%  
  modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**N.Stage**") %>% 
  bold_labels() %>%
  as_gt() %>%  # Convert to gt table for further formatting
  gt::tab_header(
    title = "Table 1: Summary Statistics Stratified by N.Stage",
    subtitle = "Continuous variables are presented as Median (IQR)"
  ) %>%
  gt::cols_label(
    label = md("**Variable**"),
    stat_0 = md("**Overall**"),
    p.value = md("**p-value**")
  ) %>%
  gt::tab_options(
    table.font.names = "Arial",
    table.border.top.width = gt::px(2),
    table.border.top.color = "black",
    table.border.bottom.width = gt::px(2),
    table.border.bottom.color = "black",
    table_body.border.bottom.width = gt::px(1),
    table_body.border.bottom.color = "black",
    column_labels.font.weight = "bold",
    column_labels.border.top.width = gt::px(2),
    column_labels.border.top.color = "black",
    column_labels.border.bottom.width = gt::px(2),
    column_labels.border.bottom.color = "black",
    table_body.hlines.width = gt::px(1),
    table_body.hlines.color = "black",
    row_group.border.top.width = gt::px(2),
    row_group.border.top.color = "black",
    row_group.border.bottom.width = gt::px(2),
    row_group.border.bottom.color = "black"
  )


table_one


```


